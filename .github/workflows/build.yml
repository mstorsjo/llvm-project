name: Build
on:
  push:
    paths:

jobs:
  pgo:
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - { lto: OFF, dylib: OFF, instrumentation: IR }
          - { lto: OFF, dylib: OFF, instrumentation: Frontend }
    steps:
      - name: Install dependencies
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update && sudo apt-get install ninja-build hyperfine wine64 wine32
          wine wineboot
      - name: Download toolchain
        run: |
          curl -LO https://github.com/mstorsjo/llvm-mingw/releases/download/nightly/llvm-mingw-nightly-ucrt-ubuntu-22.04-x86_64.tar.xz
          tar -Jxf llvm-mingw-*.tar.xz
          rm llvm-mingw-*.tar.xz
          sudo mv llvm-mingw* /opt/llvm-mingw
          echo /opt/llvm-mingw/bin >> $GITHUB_PATH
      - uses: actions/checkout@v4
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1
        with:
          max-size: 700M
          key: pgo-nightly-${{matrix.lto}}-${{matrix.dylib}}-${{matrix.instrumentation}}
      - name: Build profile runtime
        run: |
          cd compiler-rt
          mkdir build
          cd build
          cmake .. \
            -G Ninja \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=$(clang --print-resource-dir)
          ninja
          ninja install
      - name: Build instrumented
        run: |
          mkdir build
          cd build
          cmake ../llvm \
            -G Ninja \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_BUILD_TYPE=Release \
            -DLLVM_USE_LINKER=lld \
            -DLLVM_TARGETS_TO_BUILD=X86 \
            -DLLVM_ENABLE_PROJECTS="clang" \
            -DLLVM_LINK_LLVM_DYLIB=${{matrix.dylib}} \
            -DLLVM_ENABLE_LTO=${{matrix.lto}} \
            -DLLVM_BUILD_INSTRUMENTED=${{matrix.instrumentation}} \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
          ninja clang
      - name: Profile
        run: |
          cd build
          rm profiles/*
          curl -LO https://sqlite.org/2025/sqlite-amalgamation-3480000.zip
          unzip sqlite-*.zip
          rm sqlite-*.zip
          mv sqlite-*/sqlite3.c .
          bin/clang -c sqlite3.c -O3
          llvm-profdata merge -output ../profile.profdata profiles/*
      - name: Cross-build with PGO
        run: |
          mkdir build-pgo
          cd build-pgo
          cmake ../llvm \
            -G Ninja \
            -DCMAKE_C_COMPILER=i686-w64-mingw32-clang \
            -DCMAKE_CXX_COMPILER=i686-w64-mingw32-clang++ \
            -DCMAKE_RC_COMPILER=i686-w64-mingw32-windres \
            -DCMAKE_SYSTEM_NAME=Windows \
            -DCMAKE_SYSTEM_PROCESSOR=i686 \
            -DCMAKE_FIND_ROOT_PATH=/opt/llvm-mingw/i686-w64-mingw32 \
            -DCMAKE_FIND_ROOT_PATH_MODE_PROGRAM=NEVER \
            -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY \
            -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY \
            -DCMAKE_FIND_ROOT_PATH_MODE_PACKAGE=ONLY \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/../clang-cross-pgo-lto-${{matrix.lto}}-dylib-${{matrix.dylib}}-instrumentation-${{matrix.instrumentation}} \
            -DLLVM_INSTALL_TOOLCHAIN_ONLY=ON \
            -DLLVM_TARGETS_TO_BUILD=X86 \
            -DLLVM_ENABLE_PROJECTS="clang" \
            -DLLVM_LINK_LLVM_DYLIB=OFF \
            -DLLVM_ENABLE_LTO=OFF \
            -DLLVM_PROFDATA_FILE=../profile.profdata
          ninja clang
          ninja install-clang-stripped install-clang-resource-headers
          cd ..
          tar -Jcvf clang-cross.tar.xz clang-cross*
      - name: Download toolchain
        run: |
          curl -LO https://github.com/mstorsjo/llvm-mingw/releases/download/nightly/llvm-mingw-nightly-ucrt-i686.zip
          unzip llvm-mingw-*.zip
          rm llvm-mingw-*.zip
          mv llvm-mingw-* llvm-mingw
      - name: Update clang binary
        run: |
          cp clang-cross*/bin/clang.exe llvm-mingw/bin/clang-20.exe
      - name: Benchmark
        run: |
          set -x
          curl -LO https://sqlite.org/2025/sqlite-amalgamation-3480000.zip
          unzip sqlite-*.zip
          rm sqlite-*.zip
          mv sqlite-*/sqlite3.c .
          wine llvm-mingw/bin/x86_64-w64-mingw32-clang.exe -c sqlite3.c -O3
          hyperfine -m 3 -M 6 "wine llvm-mingw/bin/x86_64-w64-mingw32-clang.exe -c sqlite3.c -O3"
      - name: Bundle up
        run: |
          mv llvm-mingw llvm-mingw-${{matrix.instrumentation}}
          zip -9r llvm-mingw-patched-${{matrix.instrumentation}}.zip llvm-mingw-*
      - uses: actions/upload-artifact@v4
        with:
          name: clang-cross-pgo-${{matrix.instrumentation}}
          path: |
            clang*.tar.xz
            llvm-mingw-patched*.zip
          retention-days: 7

  benchmark:
    runs-on: ubuntu-24.04
    needs: [pgo]
    steps:
      - name: Install dependencies
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update && sudo apt-get install hyperfine wine64 wine32
          wine wineboot
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true
      - name: Unpack
        run: |
          for i in llvm-mingw-patched*.zip; do
            unzip $i
          done
          rm llvm-mingw-patched*.zip
      - name: Benchmark
        run: |
          set -x
          curl -LO https://sqlite.org/2025/sqlite-amalgamation-3480000.zip
          unzip sqlite-*.zip
          rm sqlite-*.zip
          mv sqlite-*/sqlite3.c .
          for i in llvm-mingw-*; do
            hyperfine -m 3 -M 6 "wine $i/bin/x86_64-w64-mingw32-clang.exe -c sqlite3.c -O3"
          done
